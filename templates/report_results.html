{% extends "base.html" %}

{% block title %}Dashboard â€” Law Firm Insights{% endblock %}

{% block content %}
<section class="dashboard-page">
  <div class="container">

    <!-- â”€â”€ Page header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="dashboard-header">
      <div>
        <h1 style="font-size:clamp(1.5rem,3vw,2rem)">Client Feedback Dashboard</h1>
        <p class="header-subtitle">Your analysis results and downloadable reports</p>
      </div>
      <div class="dashboard-actions">
        <a href="{{ url_for('upload') }}" class="btn btn-secondary">
          <span class="btn-icon">ğŸ“¤</span> Upload Reviews
        </a>
        {# â”€â”€ PLUG IN: only shown when data exists â”€â”€ #}
        {% if total_reviews > 0 %}
        <a href="{{ url_for('download_pdf') }}"
           class="btn btn-teal"
           id="downloadPdfBtn"
           onclick="this.innerHTML='â³ Generatingâ€¦';this.style.pointerEvents='none'">
          <span class="btn-icon">ğŸ“„</span> Download PDF Report
        </a>
        {% endif %}
        <form method="POST" action="{{ url_for('clear_reviews') }}" class="inline-form"
              onsubmit="return confirm('Delete all reviews? This cannot be undone.')">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-outline">ğŸ—‘ï¸ Clear All</button>
        </form>
      </div>
    </div>

    <!-- â”€â”€ Trial usage notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {# â”€â”€ PLUG IN: reports_remaining and upgrade_needed from your view â”€â”€ #}
    {% if reports_remaining is defined and reports_remaining is not none and not upgrade_needed %}
    <div class="usage-notice">
      <div class="usage-info">
        <span>ğŸ“Š</span>
        <span>
          <strong>Free Trial:</strong>
          {{ reports_remaining }} report{% if reports_remaining != 1 %}s{% endif %} remaining
        </span>
      </div>
      <a href="{{ url_for('pricing') }}" class="upgrade-link">Upgrade for unlimited â†’</a>
    </div>
    {% endif %}


    <!-- â”€â”€ UPGRADE WALL (trial exhausted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {% if upgrade_needed %}
    <div class="upgrade-required-section">
      <div class="upgrade-card">
        <span class="upgrade-icon">ğŸ”’</span>
        <h2>Trial Limit Reached</h2>
        <p class="upgrade-message">
          You've used all 3 trial reports. Upgrade to generate new reports.
          Your existing reports are still available to download in the history below.
        </p>
        <div class="upgrade-cta" style="flex-direction:column;gap:var(--s4)">
          <a href="{{ url_for('pricing') }}" class="btn btn-teal btn-lg">View Pricing &amp; Upgrade</a>

          <!-- Transparent pricing summary â€” no dark patterns -->
          <div style="background:var(--bg-soft);border:1px solid var(--rule);border-radius:var(--r-lg);padding:var(--s6);text-align:left;max-width:420px;width:100%">
            <p style="font-size:.75rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:var(--s4)">Your options</p>
            <div style="display:flex;flex-direction:column;gap:var(--s4)">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:var(--s4)">
                <div>
                  <strong style="font-size:.9375rem;color:var(--ink)">Single Report</strong>
                  <p style="font-size:.8125rem;color:var(--muted);margin:0">One complete analysis + PDF. No subscription.</p>
                </div>
                <a href="{{ url_for('pricing') }}" class="btn btn-secondary btn-sm" style="flex-shrink:0">
                  {# â”€â”€ PLUG IN: your one-time price â”€â”€ #}
                  From $49
                </a>
              </div>
              <div style="height:1px;background:var(--rule)"></div>
              <div style="display:flex;align-items:center;justify-content:space-between;gap:var(--s4)">
                <div>
                  <strong style="font-size:.9375rem;color:var(--ink)">Ongoing Insights</strong>
                  <p style="font-size:.8125rem;color:var(--muted);margin:0">Unlimited reports + trend tracking. Cancel anytime.</p>
                </div>
                <a href="{{ url_for('pricing') }}" class="btn btn-secondary btn-sm" style="flex-shrink:0">
                  {# â”€â”€ PLUG IN: your subscription price â”€â”€ #}
                  From $99/mo
                </a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
    {% endif %}


    <!-- â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {# â”€â”€ PLUG IN: total_reviews from your view â”€â”€ #}
    {% if total_reviews == 0 %}
    <div class="empty-state-section">
      <div class="empty-state-card">
        <span class="empty-icon">ğŸ“Š</span>
        <h2>No reviews yet</h2>
        <p class="empty-message">
          Upload a CSV of client reviews to generate your first analysis.
          Results appear here within seconds of uploading.
        </p>
        <div class="empty-actions">
          <a href="{{ url_for('upload') }}" class="btn btn-teal btn-lg">
            <span class="btn-icon">ğŸ“¤</span> Upload CSV File
          </a>
        </div>
        <!-- Preview of what the dashboard will look like -->
        <div style="margin-top:var(--s10);padding-top:var(--s8);border-top:1px solid var(--rule);text-align:left">
          <p style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:var(--s4)">Your dashboard will show</p>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--s4);opacity:.35;pointer-events:none">
            {% for label in ['Reviews Analyzed','Average Rating','Themes Found'] %}
            <div style="background:var(--bg-soft);border:1px solid var(--rule);border-radius:var(--r-md);padding:var(--s5)">
              <div style="font-family:var(--font-serif);font-size:1.75rem;color:var(--ink)">â€”</div>
              <div style="font-size:.75rem;color:var(--muted);margin-top:4px">{{ label }}</div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    {% else %}

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         INSIGHTS (data exists)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- Overview stats -->
    <div style="margin-bottom:var(--s10)">
      <h2 class="section-heading">Overview</h2>
      <div class="stats-grid">
        {# â”€â”€ PLUG IN: total_reviews, avg_rating, themes list from your view â”€â”€ #}
        <div class="stat-card">
          <span class="stat-icon">ğŸ“</span>
          <div>
            <div class="stat-value">{{ total_reviews }}</div>
            <div class="stat-label">Reviews Analyzed</div>
          </div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">â˜…</span>
          <div>
            <div class="stat-value">{{ "%.2f"|format(avg_rating) }}</div>
            <div class="stat-label">Average Rating / 5.0</div>
          </div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ğŸ”</span>
          <div>
            <div class="stat-value">{{ themes|length }}</div>
            <div class="stat-label">Themes Identified</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Themes -->
    {% if themes %}
    <div class="feedback-section" style="margin-bottom:var(--s6)">
      <h2 class="section-heading">Key Themes Across All Feedback</h2>
      <div class="themes-grid">
        {# â”€â”€ PLUG IN: theme objects with .name, .mentions, .percentage â”€â”€ #}
        {% for theme in themes %}
        <div class="theme-card">
          <h4>{{ theme.name }}</h4>
          <p>{{ theme.mentions }} mentions Â· {{ "%.1f"|format(theme.percentage) }}%</p>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Top praise (preview: 3 shown, more in PDF) -->
    {% if top_praise %}
    <div class="feedback-section">
      <h2 class="section-heading">
        <span class="heading-icon success">âœ“</span>
        Top Positive Feedback
      </h2>
      <p style="font-size:.875rem;color:var(--muted);margin-bottom:var(--s5)">
        Showing 3 of {{ top_praise|length }} positive reviews â€”
        the full list is in your PDF report.
      </p>
      <div class="reviews-list">
        {# â”€â”€ PLUG IN: top_praise list of review objects â”€â”€ #}
        {% for review in top_praise[:3] %}
        <div class="review-card positive">
          <div class="review-header">
            <span class="review-rating">{% for i in range(review.rating) %}â˜…{% endfor %}</span>
            <span class="review-date">{{ review.date }}</span>
          </div>
          <div class="review-text">
            {{ review.review_text[:300] }}{% if review.review_text|length > 300 %}â€¦{% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Areas for improvement â€” preview with paywall nudge for free tier -->
    {% if top_complaints %}
    <div class="feedback-section">
      <h2 class="section-heading">
        <span class="heading-icon warning">âš </span>
        Opportunities for Improvement
      </h2>
      <p style="font-size:.875rem;color:var(--muted);margin-bottom:var(--s5)">
        Showing 3 of {{ top_complaints|length }} critical reviews.
        The PDF report includes prioritized action plans for each identified theme.
      </p>
      <div class="reviews-list">
        {# â”€â”€ PLUG IN: top_complaints list of review objects â”€â”€ #}
        {% for review in top_complaints[:3] %}
        <div class="review-card negative">
          <div class="review-header">
            <span class="review-rating">{% for i in range(review.rating) %}â˜…{% endfor %}</span>
            <span class="review-date">{{ review.date }}</span>
          </div>
          <div class="review-text">
            {{ review.review_text[:300] }}{% if review.review_text|length > 300 %}â€¦{% endif %}
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Paywall nudge â€” shown if trial is exhausted -->
      {% if upgrade_needed %}
      <div style="margin-top:var(--s8);background:var(--navy-50);border:1px solid var(--navy-100);border-radius:var(--r-lg);padding:var(--s8);text-align:center">
        <h3 style="font-size:1.125rem;margin-bottom:var(--s3)">Get the full action plan in your PDF report</h3>
        <p style="font-size:.9375rem;color:var(--body);max-width:480px;margin:0 auto var(--s6);line-height:1.7">
          The PDF includes a prioritized action plan for every theme â€” with specific steps, suggested owners, and recommended timelines.
          Ready to present at your next partner meeting.
        </p>
        <!-- Two upgrade options, clearly labelled, no dark patterns -->
        <div style="display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:var(--s3)">
          <a href="{{ url_for('pricing') }}" class="btn btn-teal btn-lg">Upgrade to Download â†’</a>
          <a href="{{ url_for('pricing') }}" class="btn btn-outline btn-lg">See all pricing options</a>
        </div>
        <p style="font-size:.8125rem;color:var(--muted);margin-top:var(--s4)">
          Single report from $49 Â· Subscription from $99/mo Â· Cancel anytime
        </p>
      </div>
      {% endif %}

    </div>
    {% endif %}

    {% endif %}{# end total_reviews > 0 #}


    <!-- â”€â”€ Report history (always visible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="reports-history-section">
      <h2 class="section-heading">Report History</h2>
      {# â”€â”€ PLUG IN: reports_history list of report objects from DB â”€â”€ #}
      {% if reports_history %}
      <div class="table-mobile-wrap">
        <table class="reports-history-table">
          <thead>
            <tr>
              <th>Created</th>
              <th>Reviews</th>
              <th>Plan</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports_history %}
            <tr>
              <td>{{ report.created_at }}</td>
              <td>{{ report.total_reviews }}</td>
              <td>
                <span class="plan-badge plan-{{ (report.subscription_type_at_creation or 'trial')|lower }}">
                  {{ report.plan_label }}
                </span>
              </td>
              <td>
                {# â”€â”€ PLUG IN: download_report takes report.id â”€â”€ #}
                <a href="{{ url_for('download_report', report_id=report.id) }}"
                   class="btn btn-sm btn-teal"
                   onclick="this.innerText='Generatingâ€¦';this.style.pointerEvents='none'">
                  Download PDF
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p style="color:var(--muted);font-size:.9375rem">
        No saved reports yet. Upload a CSV to generate your first report.
      </p>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}
